# Maintainer: Luca Weiss <luca (at) z3ntu (dot) xyz>

pkgname="pixi"
pkgver='0.26.1'
pkgrel='1'
pkgdesc='A cross-platform, multi-language package manager and workflow tool built on the foundation of the conda ecosystem'
arch=('x86_64')
url="https://github.com/prefix-dev/${pkgname}"
license=('BSD-3-Clause')
makedepends=('rust')
source=("${pkgname}-${pkgver}.tar.gz::${url}/archive/refs/tags/v${pkgver}.tar.gz")
sha512sums=('e54e3be95c31f07ca9db92a18f3047ceae26726073052b4c8aec8df582ed61a1cad40cd2a2deacb13efe750b33009ddd1822374c2435a07e26617f0d13a3b26e')

pkgver() {
    cd "${pkgname}-${pkgver}"
    printf 'r%s.%s' "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    cd "${pkgname}-${pkgver}"
    export RUSTUP_TOOLCHAIN=stable
    cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"
}

build() {
    cd "${pkgname}-${pkgver}"
    export RUSTUP_TOOLCHAIN=stable
    export CARGO_TARGET_DIR=target
    cargo build --frozen --release --all-features
}

check() {
    cd "${pkgname}-${pkgver}"
    export RUSTUP_TOOLCHAIN=stable
    cargo test --frozen --all-features --workspace
}

package() {
    cd "${pkgname}-${pkgver}"
    install -Dm 0755 'target/release/${pkgname}' -t "${pkgdir}/usr/bin"
}
